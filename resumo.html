<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resumo do Agendamento</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#fff; --text:#111827; --muted:#6b7280; --border:#e5e7eb; --accent:#111; --radius:14px; --chip:#f3f4f6; --ok:#10b981; --warn:#f59e0b;}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:Inter,system-ui,sans-serif;color:var(--text)}
    .wrap{max-width:460px;margin:0 auto;padding:20px}
    h1{margin:0 0 8px;font-size:20px;font-weight:800}
    .muted{color:var(--muted);font-size:13px}
    .card{border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin:16px 0;background:#fff}
    .row{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);font-size:15px}
    .row:last-child{border-bottom:none}
    .row .label{color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px}
    .i-title{font-weight:700;font-size:14px}
    .i-sub{color:var(--muted);font-size:12px;margin-top:2px}
    .chip{background:var(--chip);border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:12px}
    .total{font-weight:800}
    .btn{padding:12px 16px;border-radius:999px;border:1px solid var(--border);font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .footer{margin-top:16px;display:flex;gap:10px;justify-content:space-between}
    .error{background:#fee2e2;border:1px solid #ef4444;color:#991b1b;padding:8px;border-radius:10px;font-size:13px;margin-bottom:8px}
    .ok{color:var(--ok);font-weight:700}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Revise e confirme</h1>
  <div class="muted" id="hint">Conferindo tudo antes de confirmar seu agendamento.</div>

  <div id="alert" class="error" style="display:none"></div>

  <div class="card">
    <div class="row"><div class="label">Profissional</div><div id="rProf">—</div></div>
    <div class="row"><div class="label">Data</div><div id="rDate">—</div></div>
    <div class="row"><div class="label">Horário</div><div id="rTime">—</div></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px;font-size:16px;font-weight:800">Serviços</h2>
    <div id="services" class="list"></div>
    <div class="row" style="margin-top:8px"><div class="label">Duração total</div><div id="rDuration">—</div></div>
    <div class="row"><div class="label">Subtotal</div><div id="rSubtotal">—</div></div>
    <div class="row"><div class="label">Sinal (30%)</div><div id="rDeposit">—</div></div>
    <div class="row total"><div>Total</div><div id="rTotal">—</div></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px;font-size:16px;font-weight:800">Seu contato</h2>
    <div class="row"><div class="label">Nome</div><div id="rName">—</div></div>
    <div class="row"><div class="label">Telefone</div><div id="rPhone">—</div></div>
    <div class="row"><div class="label">E-mail</div><div id="rEmail">—</div></div>
  </div>

  <div class="footer">
    <button class="btn" id="btnBack">← Voltar</button>
    <button class="btn primary" id="btnConfirm">Confirmar agendamento</button>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const N8N_BASE  = localStorage.getItem('n8n_base') || 'https://primary-odonto.up.railway.app/webhook/barber';
  const QUOTE_URL = `${N8N_BASE}/quote`;            // GET ?services=1,2&professional_id=...&date=YYYY-MM-DD&time=HH:MM
  const CREATE_URL= `${N8N_BASE}/booking/create`;   // POST JSON

  // Tokens (se login já foi feito)
  const ACCESS_TOKEN = localStorage.getItem('sb_access_token') || localStorage.getItem('access_token') || '';

  // ====== ELEMENTOS ======
  const alertBox   = document.getElementById('alert');
  const servicesEl = document.getElementById('services');

  const rProf = document.getElementById('rProf');
  const rDate = document.getElementById('rDate');
  const rTime = document.getElementById('rTime');
  const rDuration = document.getElementById('rDuration');
  const rSubtotal = document.getElementById('rSubtotal');
  const rDeposit  = document.getElementById('rDeposit');
  const rTotal    = document.getElementById('rTotal');

  const rName  = document.getElementById('rName');
  const rPhone = document.getElementById('rPhone');
  const rEmail = document.getElementById('rEmail');

  const btnBack    = document.getElementById('btnBack');
  const btnConfirm = document.getElementById('btnConfirm');

  // ====== HELPERS ======
  const BRL = (cents)=> (Number(cents||0)/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const fmtDate = (iso)=> {
    if(!iso) return '—';
    const [y,m,d]=iso.split('-').map(Number);
    return new Date(y,m-1,d).toLocaleDateString('pt-BR',{weekday:'long',day:'2-digit',month:'long'});
  };

  function showError(msg){
    alertBox.style.display='block';
    alertBox.textContent = msg;
  }
  function hideError(){ alertBox.style.display='none'; }

  // ====== STATE (carregado do funil) ======
  const servicesIds = JSON.parse(localStorage.getItem('booking_services') || '[]');    // array de IDs
  const profId      = localStorage.getItem('booking_barber') || '';
  const datetime    = JSON.parse(localStorage.getItem('booking_datetime') || '{}');    // {date,time}
  const profile     = JSON.parse(localStorage.getItem('booking_profile')  || '{}');    // {nome,sobrenome,telefone,email}

  // pré-preenche contato
  rName.textContent  = [profile.nome, profile.sobrenome].filter(Boolean).join(' ') || '—';
  rPhone.textContent = profile.telefone || '—';
  rEmail.textContent = profile.email || '—';

  rDate.textContent = fmtDate(datetime.date||'');
  rTime.textContent = (datetime.time||'—');

  // ====== FETCH QUOTE ======
  async function loadQuote(){
    try{
      hideError();
      servicesEl.innerHTML = `<div class="muted">Carregando orçamento…</div>`;

      const qs = new URLSearchParams({
        services: servicesIds.join(','),
        professional_id: profId || '',
        date: datetime.date || '',
        time: datetime.time || '',
      });

      const headers = {};
      if (ACCESS_TOKEN) headers['Authorization'] = `Bearer ${ACCESS_TOKEN}`;

      const res = await fetch(`${QUOTE_URL}?${qs.toString()}`, { headers });
      if(!res.ok) throw new Error(`Erro ao orçar (HTTP ${res.status})`);
      const data = await res.json();

      // Esperado do n8n:
      // {
      //   professional: { id, name, avatar },
      //   items: [{ id, name, price_cents, duration_min }...],
      //   total_cents, total_duration_min, deposit_cents
      // }
      rProf.textContent    = (data.professional && data.professional.name) || '—';
      rDuration.textContent= `${data.total_duration_min || 0} min`;
      rSubtotal.textContent= BRL(data.total_cents || 0);
      rDeposit.textContent = BRL(data.deposit_cents || Math.round((data.total_cents||0)*0.3));
      rTotal.textContent   = BRL(data.total_cents || 0);

      // lista de serviços
      servicesEl.innerHTML = (data.items||[]).map(it => `
        <div class="item">
          <div>
            <div class="i-title">${it.name||'Serviço'}</div>
            <div class="i-sub">${it.duration_min||0} min</div>
          </div>
          <div class="i-title">${BRL(it.price_cents||0)}</div>
        </div>
      `).join('') || `<div class="muted">Nenhum serviço.</div>`;

      // Guardar um snapshot do orçamento para enviar no create
      sessionStorage.setItem('booking_quote', JSON.stringify(data));

    }catch(err){
      console.error(err);
      showError(err.message || 'Falha ao carregar orçamento');
      servicesEl.innerHTML = '';
    }
  }

  // ====== CONFIRMAR ======
  btnConfirm.addEventListener('click', async ()=>{
    try{
      hideError();
      btnConfirm.disabled = true;
      btnConfirm.textContent = 'Confirmando…';

      const quote = JSON.parse(sessionStorage.getItem('booking_quote') || '{}');

      const payload = {
        professional_id: profId,
        services: servicesIds,               // ids
        date: datetime.date,
        time: datetime.time,
        // opcional: dados do perfil (se ainda não logado, o n8n pode criar lead/cliente)
        contact: {
          name: [profile.nome, profile.sobrenome].filter(Boolean).join(' ') || '',
          phone: profile.telefone || '',
          email: profile.email || ''
        },
        // mandar o resumo para o n8n persistir sem recalcular se preferir:
        quote
      };

      const headers = { 'Content-Type':'application/json' };
      if (ACCESS_TOKEN) headers['Authorization'] = `Bearer ${ACCESS_TOKEN}`;

      const res = await fetch(CREATE_URL, { method:'POST', headers, body: JSON.stringify(payload) });
      const data = await res.json();

      if(!res.ok || data.ok === false){
        throw new Error(data.message || `Falha ao criar agendamento (HTTP ${res.status})`);
      }

      // Exemplo de retorno esperado:
      // { ok:true, booking_id, payment: { provider:'pix', status:'pending', amount_cents, qr_code_url, ... } }
      alert('Agendamento confirmado com sucesso!');
      console.log('BOOKING CREATED:', data);

      // Se houver PIX/checkout:
      if (data.payment?.qr_code_url) {
        // redirecione para uma página de pagamento/PIX
        // location.href = `pix.html?booking=${encodeURIComponent(data.booking_id)}`;
        window.open(data.payment.qr_code_url, '_blank');
      } else {
        // volta para home ou “minha conta”
        location.href = 'index.html';
      }

    }catch(err){
      console.error(err);
      showError(err.message || 'Erro ao confirmar o agendamento');
    }finally{
      btnConfirm.disabled = false;
      btnConfirm.textContent = 'Confirmar agendamento';
    }
  });

  btnBack.addEventListener('click', ()=> history.back());

  // start
  loadQuote();
</script>
</body>
</html>
