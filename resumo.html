<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resumo do Agendamento</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#fff;--text:#111827;--muted:#6b7280;--border:#e5e7eb;--accent:#111;--radius:14px;--chip:#f3f4f6}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);font-family:Inter,system-ui,sans-serif;color:var(--text)}
    .wrap{max-width:460px;margin:0 auto;padding:20px}
    h1{margin:0 0 8px;font-size:20px;font-weight:800}
    .muted{color:var(--muted);font-size:13px}
    .card{border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin:16px 0;background:#fff}
    .row{display:flex;justify-content:space-between;gap:12px;padding:8px 0;border-bottom:1px solid var(--border);font-size:15px}
    .row:last-child{border-bottom:none}
    .row .label{color:var(--muted)}
    .list{display:flex;flex-direction:column;gap:10px}
    .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--border);border-radius:12px;padding:10px}
    .i-title{font-weight:700;font-size:14px}
    .i-sub{color:var(--muted);font-size:12px;margin-top:2px}
    .total{font-weight:800}
    .btn{padding:12px 16px;border-radius:999px;border:1px solid var(--border);font-weight:700;cursor:pointer}
    .btn.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
    .footer{margin-top:16px;display:flex;gap:10px;justify-content:space-between}
    .error{background:#fee2e2;border:1px solid #ef4444;color:#991b1b;padding:8px;border-radius:10px;font-size:13px;margin-bottom:8px;display:none}
  </style>
</head>
<body>
<div class="wrap">
  <h1>Revise e confirme</h1>
  <div class="muted">Conferindo tudo antes de confirmar seu agendamento.</div>

  <div id="alert" class="error"></div>

  <div class="card">
    <div class="row"><div class="label">Profissional</div><div id="rProf">—</div></div>
    <div class="row"><div class="label">Data</div><div id="rDate">—</div></div>
    <div class="row"><div class="label">Horário</div><div id="rTime">—</div></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px;font-size:16px;font-weight:800">Serviços</h2>
    <div id="services" class="list"></div>
    <div class="row" style="margin-top:8px"><div class="label">Duração total</div><div id="rDuration">—</div></div>
    <div class="row"><div class="label">Subtotal</div><div id="rSubtotal">—</div></div>
    <div class="row"><div class="label">Sinal (30%)</div><div id="rDeposit">—</div></div>
    <div class="row total"><div>Total</div><div id="rTotal">—</div></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 8px;font-size:16px;font-weight:800">Seu contato</h2>
    <div class="row"><div class="label">Nome</div><div id="rName">—</div></div>
    <div class="row"><div class="label">Telefone</div><div id="rPhone">—</div></div>
    <div class="row"><div class="label">E-mail</div><div id="rEmail">—</div></div>
  </div>

  <div class="footer">
    <button class="btn" id="btnBack">← Voltar</button>
    <button class="btn primary" id="btnConfirm">Confirmar agendamento</button>
  </div>
</div>

<script src="js/booking-helpers.js"></script>
<script>
  // ===== CONFIG =====
  const N8N_BASE   = localStorage.getItem('n8n_base') || 'https://primary-odonto.up.railway.app/webhook/barber';
  const QUOTE_URL  = `${N8N_BASE}/quote`;          // GET
  const CREATE_URL = `${N8N_BASE}/booking/create`; // POST
  const TOKEN      = localStorage.getItem('sb_access_token') || localStorage.getItem('access_token') || '';

  // ===== UI =====
  const alertBox   = document.getElementById('alert');
  const servicesEl = document.getElementById('services');
  const rProf = rById('rProf'), rDate = rById('rDate'), rTime = rById('rTime');
  const rDuration = rById('rDuration'), rSubtotal = rById('rSubtotal'), rDeposit = rById('rDeposit'), rTotal = rById('rTotal');
  const rName = rById('rName'), rPhone = rById('rPhone'), rEmail = rById('rEmail');
  const btnBack = rById('btnBack'), btnConfirm = rById('btnConfirm');
  function rById(id){ return document.getElementById(id); }
  const BRL = (c=0)=> (Number(c)/100).toLocaleString('pt-BR',{style:'currency',currency:'BRL'});
  const fmtDate = (iso)=> iso? (()=>{const [y,m,d]=iso.split('-').map(Number);return new Date(y,m-1,d).toLocaleDateString('pt-BR',{weekday:'long',day:'2-digit',month:'long'})})() : '—';
  const showError=(m)=>{alertBox.textContent=m;alertBox.style.display='block'}; const hideError=()=>{alertBox.style.display='none'};

  // ===== STATE =====
  const servicesIds = Booking.getServices();
  const profId      = Booking.getProfessional();
  const { date, time } = Booking.getDateTime();
  const profile     = Booking.getProfile();

  // preenche contato & data/hora
  rName.textContent  = [profile.nome, profile.sobrenome].filter(Boolean).join(' ') || '—';
  rPhone.textContent = profile.telefone || '—';
  rEmail.textContent = profile.email || '—';
  rDate.textContent  = fmtDate(date);
  rTime.textContent  = time || '—';

  // debug (remover depois se quiser)
  Booking.mountDebug('.wrap');

  // valida antes de chamar o n8n
  function validate() {
    if (!Array.isArray(servicesIds) || servicesIds.length===0) return 'Nenhum serviço selecionado.';
    if (!profId)  return 'Profissional não selecionado.';
    if (!date)    return 'Data não selecionada.';
    if (!time)    return 'Hora não selecionada.';
    return '';
  }

  async function loadQuote(){
    try{
      const v = validate(); if (v) throw new Error(v);
      hideError();
      servicesEl.innerHTML = `<div class="muted">Carregando orçamento…</div>`;

      const qs = new URLSearchParams({ services: servicesIds.join(','), professional_id: profId, date, time });
      const headers = {}; if (TOKEN) headers['Authorization'] = `Bearer ${TOKEN}`;
      const res = await fetch(`${QUOTE_URL}?${qs.toString()}`, { headers });
      if(!res.ok) throw new Error(`Erro ao orçar (HTTP ${res.status})`);
      const data = await res.json();

      // normalização mínima
      const prof = data.professional || data.profissional || {};
      const items = Array.isArray(data.items) ? data.items : (data.servicos || []);
      const total = data.total_cents ?? data.total ?? 0;
      const dur   = data.total_duration_min ?? data.duracao_total ?? 0;
      const dep   = data.deposit_cents ?? Math.round(total*0.3);

      rProf.textContent     = prof.name || prof.display_name || '—';
      rDuration.textContent = `${dur} min`;
      rSubtotal.textContent = BRL(total);
      rDeposit.textContent  = BRL(dep);
      rTotal.textContent    = BRL(total);

      servicesEl.innerHTML = items.length
        ? items.map(s => `
            <div class="item">
              <div>
                <div class="i-title">${s.name || s.nome || 'Serviço'}</div>
                <div class="i-sub">${s.duration_min ?? s.duracao_min ?? 0} min</div>
              </div>
              <div class="i-title">${BRL(s.price_cents ?? s.preco_cents ?? 0)}</div>
            </div>
          `).join('')
        : `<div class="muted">Nenhum serviço.</div>`;

      sessionStorage.setItem('booking_quote', JSON.stringify({ professional: prof, items, total_cents: total, total_duration_min: dur, deposit_cents: dep }));
    } catch (e) {
      console.error(e); showError(e.message || 'Falha ao carregar orçamento'); servicesEl.innerHTML='';
    }
  }

  btnConfirm.addEventListener('click', async () => {
    try{
      const v = validate(); if (v) throw new Error(v);
      hideError(); btnConfirm.disabled=true; btnConfirm.textContent='Confirmando…';

      const quote = JSON.parse(sessionStorage.getItem('booking_quote') || '{}');
      const payload = {
        professional_id: profId,
        services: servicesIds,
        date, time,
        contact: { name: [profile.nome, profile.sobrenome].filter(Boolean).join(' '), phone: profile.telefone || '', email: profile.email || '' },
        quote
      };

      const headers = { 'Content-Type':'application/json' }; if (TOKEN) headers['Authorization'] = `Bearer ${TOKEN}`;
      const res = await fetch(CREATE_URL, { method:'POST', headers, body: JSON.stringify(payload) });
      const data = await res.json();
      if(!res.ok || data.ok === false) throw new Error(data.message || `Falha ao criar agendamento (HTTP ${res.status})`);

      alert('Agendamento confirmado com sucesso!');
      if (data.payment?.qr_code_url) window.open(data.payment.qr_code_url, '_blank');
      location.href = 'index.html';
    } catch(e){
      console.error(e); showError(e.message || 'Erro ao confirmar o agendamento');
    } finally {
      btnConfirm.disabled=false; btnConfirm.textContent='Confirmar agendamento';
    }
  });

  btnBack.addEventListener('click', ()=> history.back());
  loadQuote();
</script>
</body>
</html>
